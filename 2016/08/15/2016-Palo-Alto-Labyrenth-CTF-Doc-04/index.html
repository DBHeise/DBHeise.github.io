<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>2016 Palo Alto Labyrenth CTF Doc 04 | Crazy Dave&#39;s InterTube Emporium</title>
  <meta name="author" content="Crazy Dave">
  
  <meta name="description" content="DOC 01
DOC 02
DOC 03
DOC 04 &amp;lt;- You are here
DOC 05 

Ok, so the fourth challenge is again a zip file (hash: 1A2570D5CC6E2C3A185E939DC49CB4B908B867E">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="2016 Palo Alto Labyrenth CTF Doc 04"/>
  <meta property="og:site_name" content="Crazy Dave&#39;s InterTube Emporium"/>

  
    <meta property="og:image" content="undefined"/>
  

  
    <link rel="alternative" href="/atom.xml" title="Crazy Dave&#39;s InterTube Emporium" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/cyborg.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">Crazy Dave&#39;s InterTube Emporium</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header page-header-inverse ">		
			<h1 class="title title-inverse "> 2016 Palo Alto Labyrenth CTF Doc 04</h1>
		</div>		
	






<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <ul>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-01/">DOC 01</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-02/">DOC 02</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-03/">DOC 03</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-04/">DOC 04</a> &lt;- You are here</li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/">DOC 05</a> </li>
</ul>
<p>Ok, so the fourth challenge is again a zip file (hash: 1A2570D5CC6E2C3A185E939DC49CB4B908B867E02AC84BF7ABB532B3395FB01A) and it contains a file fun.docm (hash: <a href="/data/PAN_CTF_DOCTrack_004.zip">4AE794A701D2F28BA7E6292F0463444F6A567CB7C26188A518270544252877FB</a>). Now the first thing you need to know about the newer office file formats is that they are all zip files. So yes a DOCM and a XLSX and a PPTX, etc are all ZIP files with various contents pieces inside (see <a href="https://github.com/DBHeise/fileid/wiki/zip" target="_blank" rel="external">here</a> for other zip based documents)</p>
<p>SIDENOTE: this is one of the very reasons that I wrote my <a href="https://github.com/DBHeise/fileid" target="_blank" rel="external">FileId</a> tool to begin with. Most file identification apps don’t go very much beyond magic headers. If we understand that the magic header gives us a container format (i.e. Ole Structured Storage [OLESS], ZIP, and many others), then we can parse that container and gain much more information. This is exactly what FileId does it understands OLESS files and ZIP files and has some ideas what to look for inside to figure out its true file type.</p>
<p>SIDE-SIDENOTE: Of course since its a container then we can do nasty things that were never intended to be done…like having a DOC, XLS, PPT all in a single file and all open completely different content depending on which app is opening it.</p>
<p>ok, back to the challenge at hand and DOCM file! we can verify its a DOCM by running it through <a href="https://github.com/DBHeise/fileid" target="_blank" rel="external">FileId</a> or we can simply run 7zip and extract the contents…which is what I did. Since its truly a DOCM we will find a file inside the <code>WORD</code> subfolder named <code>vbaProject.bin</code> (it actually doesn’t have to be named this, but I digress). I also happen to know that this is also an OLESS file, so again we can run it through <a href="https://github.com/DBHeise/fileid" target="_blank" rel="external">FileId</a>, but there is a known bug in <a href="https://github.com/DBHeise/fileid" target="_blank" rel="external">FileId</a> here…</p>
<p>So here we have a couple of choices as what to do next, but the underlying principle is to get to the VBA…here are several options (I did them all):</p>
<ol>
<li>use olevba.py in <a href="http://www.decalage.info/python/oletools" target="_blank" rel="external">OleTools</a> by Philippe Lagadec</li>
<li>use the office object model to open and save the file in the DOC format (won’t run macro, but will maintain them)</li>
<li>unzip the DOCM, edit the <code>vbaProject.bin</code> to remove the  protections and alter the autorun functionname (how to do this will be covered in the <a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/">DOC 05</a> writeup)</li>
</ol>
<p>So lets assume you did one of those, you’d get the following macro parts:</p>
<p>=ThisDocument=<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div></pre></td><td class="code"><pre><div class="line">#If VBA7 And Win64 Then</div><div class="line">Private Declare PtrSafe Function jFlnz8 Lib &quot;winmm.dll&quot; Alias &quot;sndPlaySoundA&quot; _</div><div class="line">       (ByVal lpszSoundName As String, ByVal uFlags As Long) As Long</div><div class="line">#Else</div><div class="line">Private Declare Function jFlnz8 Lib &quot;winmm.dll&quot; Alias &quot;sndPlaySoundA&quot; _</div><div class="line">       (ByVal lpszSoundName As String, ByVal uFlags As Long) As Long</div><div class="line">#End If</div><div class="line"></div><div class="line">Public cMSuxt As Variant</div><div class="line">Public gkKg As Object</div><div class="line">Public cN3r As String</div><div class="line">Public kZ4gU8sc As String</div><div class="line">Public qa317 As Integer</div><div class="line"></div><div class="line">Sub znOIKcDsLlMKQVsnFfWaE2bHu18RdOmKFoVb()</div><div class="line">    Selection.WholeStory</div><div class="line">    Selection.Font.ColorIndex = (Selection.Font.ColorIndex + 1) Mod 15</div><div class="line">    If Selection.Font.ColorIndex Mod 2 = 0 Then</div><div class="line">        Set gkKg = CreateObject(&quot;Excel.Application&quot;)</div><div class="line">        gkKg.Speech.speak NpuXrzgq.Label1, True</div><div class="line">        gkKg.Quit</div><div class="line">    ElseIf Selection.Font.ColorIndex Mod 2 = 1 Then</div><div class="line">        adk49an = Environ(&quot;tmp&quot;) &amp; &quot;\&quot; &amp; &quot;asdf&quot;</div><div class="line">        jFlnz8 adk49an, 1</div><div class="line">    End If</div><div class="line">    Application.OnTime Now + TimeValue(&quot;00:00:01&quot;), &quot;znOIKcDsLlMKQVsnFfWaE2bHu18RdOmKFoVb&quot;</div><div class="line">End Sub</div><div class="line"></div><div class="line">Private Sub UxKo3LivfGHxI2OtWa3KtqOgY6cRb5yrbR00(m4dYL, fviLw9)</div><div class="line">    On Error GoTo NavnYIF0:</div><div class="line">    Dim fjGeMmP8Z() As Byte</div><div class="line">    fjGeMmP8Z = Z1yiWeP.t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(m4dYL)</div><div class="line">    Z1yiWeP.pZVZ0Q8ygfA6jcSJRLEKZSyv40IDQzErCpah fjGeMmP8Z, fviLw9</div><div class="line">NavnYIF0:</div><div class="line">    GoTo VadXU4</div><div class="line">VadXU4:</div><div class="line"></div><div class="line">End Sub</div><div class="line"></div><div class="line">Private Function BqNFmKCS7cTPv9XNFOd2mCLrdqCfmdNm6HBz(dd) As Boolean</div><div class="line">    BqNFmKCS7cTPv9XNFOd2mCLrdqCfmdNm6HBz = False</div><div class="line">    On Error GoTo B3A:</div><div class="line">    Dim A4xcPiKtrr() As Byte</div><div class="line">    A4xcPiKtrr = Z1yiWeP.t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(dd)</div><div class="line">    BqNFmKCS7cTPv9XNFOd2mCLrdqCfmdNm6HBz = Z1yiWeP.Cj2XBWUOfIP7E9oOZKQEB0zFWe2Cf4NbfApB(A4xcPiKtrr)</div><div class="line">B3A:</div><div class="line">End Function</div><div class="line"></div><div class="line">Private Function zoycqKJvqznJMeMpHe7Z61xYJfLLmbObxBVy()</div><div class="line">    zoycqKJvqznJMeMpHe7Z61xYJfLLmbObxBVy = None</div><div class="line">    For Each ok0I11 In ActiveDocument.VBProject.VBComponents</div><div class="line">        l = 1</div><div class="line">        Set gjvhSFe = ok0I11.CodeModule</div><div class="line">        Do While l &lt; gjvhSFe.CountOfLines</div><div class="line">            za29rx = gjvhSFe.ProcOfLine(l, 0)</div><div class="line">            If za29rx &lt;&gt; &quot;&quot; Then</div><div class="line">                If BqNFmKCS7cTPv9XNFOd2mCLrdqCfmdNm6HBz(za29rx) Then</div><div class="line">                    zoycqKJvqznJMeMpHe7Z61xYJfLLmbObxBVy = za29rx</div><div class="line">                    GoTo CfHFE</div><div class="line">                End If</div><div class="line">                l = l + gjvhSFe.ProcCountLines(za29rx, 0)</div><div class="line">            Else</div><div class="line">                l = l + 1</div><div class="line">            End If</div><div class="line">        Loop</div><div class="line">    Next ok0I11</div><div class="line">CfHFE:</div><div class="line">End Function</div><div class="line"></div><div class="line">Private Sub XiqyXdC809pP5esSrC633ag92w0x6otQylY0()</div><div class="line">    sN2l0P = zoycqKJvqznJMeMpHe7Z61xYJfLLmbObxBVy</div><div class="line">    If Not IsNull(sN2l0P) Then</div><div class="line">        For Each LHKwfvbUC In ActiveDocument.VBProject.VBComponents</div><div class="line">            If LHKwfvbUC.Type = 1 Then</div><div class="line">                HKwfvbU = 1</div><div class="line">                Set cm = LHKwfvbUC.CodeModule</div><div class="line">                Do While HKwfvbU &lt; cm.CountOfLines</div><div class="line">                    pn = cm.ProcOfLine(HKwfvbU, 0)</div><div class="line">                    If pn &lt;&gt; &quot;&quot; Then</div><div class="line">                        UxKo3LivfGHxI2OtWa3KtqOgY6cRb5yrbR00 pn, sN2l0P</div><div class="line">                        HKwfvbU = HKwfvbU + cm.ProcCountLines(pn, 0)</div><div class="line">                    Else</div><div class="line">                        HKwfvbU = HKwfvbU + 1</div><div class="line">                    End If</div><div class="line">                Loop</div><div class="line">            End If</div><div class="line">        Next LHKwfvbUC</div><div class="line">    End If</div><div class="line">    zkceuV405Q5LjUp587OYxTI7OR9zTyPdvz8k</div><div class="line">End Sub</div><div class="line"></div><div class="line">Private Function OcbCTRJiqmq8ZHdtwfA1hsuje7UPUwkL1TcL(e2qBnJA1D, GNheMViA)</div><div class="line">    df = Environ(&quot;tmp&quot;) &amp; &quot;\&quot; &amp; e2qBnJA1D</div><div class="line">    Dim CiuxGXWXyEUw4() As Byte</div><div class="line">    CiuxGXWXyEUw4 = Z1yiWeP.t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(GNheMViA)</div><div class="line">    Open df For Binary Access Write As #1</div><div class="line">    Put #1, , CiuxGXWXyEUw4</div><div class="line">    Close #1</div><div class="line">    OcbCTRJiqmq8ZHdtwfA1hsuje7UPUwkL1TcL = df</div><div class="line">End Function</div><div class="line"></div><div class="line">Private Sub zkceuV405Q5LjUp587OYxTI7OR9zTyPdvz8k()</div><div class="line">    yRQaQqmn4iZIgFxTHSbChaoJt9SxKmV7T1L5</div><div class="line">    Selection.WholeStory</div><div class="line">    Selection.Delete</div><div class="line">    Selection.TypeText NpuXrzgq.Label1</div><div class="line">    Selection.WholeStory</div><div class="line">    Selection.Font.Size = 72</div><div class="line">    znOIKcDsLlMKQVsnFfWaE2bHu18RdOmKFoVb</div><div class="line">End Sub</div><div class="line"></div><div class="line">Private Sub yRQaQqmn4iZIgFxTHSbChaoJt9SxKmV7T1L5()</div><div class="line">    cMSuxt = Array(OcbCTRJiqmq8ZHdtwfA1hsuje7UPUwkL1TcL(&quot;asdf&quot;, NpuXrzgq.assda))</div><div class="line">    kZ4gU8sc = NpuXrzgq.Label1</div><div class="line">End Sub</div><div class="line"></div><div class="line">Public Sub Document_Open()</div><div class="line">    On Error GoTo sjjQMD:</div><div class="line">    If ActiveDocument.VBProject.VBComponents.Count &gt; 4 Then</div><div class="line">        XiqyXdC809pP5esSrC633ag92w0x6otQylY0</div><div class="line">    Else</div><div class="line">        zkceuV405Q5LjUp587OYxTI7OR9zTyPdvz8k</div><div class="line">    End If</div><div class="line">sjjQMD:</div><div class="line">    If err.Number = 6068 Or err.Number = 50289 Then</div><div class="line">        zkceuV405Q5LjUp587OYxTI7OR9zTyPdvz8k</div><div class="line">    Else</div><div class="line">        Resume Next</div><div class="line">    End If</div><div class="line">End Sub</div></pre></td></tr></table></figure></p>
<p>=Z1yiWeP=<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line">Attribute VB_Name = &quot;Z1yiWeP&quot;</div><div class="line">Function d7KRoSK5UEDh35jJNkj0TtcJjOIbmBZlyCql(JwFeyAb5x, AgkWcn As Byte) As Variant</div><div class="line">    Dim bzTec() As Byte</div><div class="line">    ReDim bzTec(UBound(JwFeyAb5x))</div><div class="line">    For cz9vzhBR = 0 To UBound(JwFeyAb5x)</div><div class="line">        bzTec(cz9vzhBR) = JwFeyAb5x(cz9vzhBR) Xor AgkWcn</div><div class="line">    Next</div><div class="line">    d7KRoSK5UEDh35jJNkj0TtcJjOIbmBZlyCql = bzTec</div><div class="line">End Function</div><div class="line"></div><div class="line">Private Sub ir0a6FeeF0LUThieRM7v6qxfWFJD1dT6BzDH()</div><div class="line">    Dim opy7ej As VBIDE.VBProject</div><div class="line">    Dim PiO3rcWe As VBIDE.VBComponent</div><div class="line">    Set opy7ej = ActiveDocument.VBProject</div><div class="line">    Set PiO3rcWe = opy7ej.VBComponents(&quot;IadnoxRap3&quot;)</div><div class="line">    opy7ej.VBComponents.Remove PiO3rcWe</div><div class="line">End Sub</div><div class="line"></div><div class="line">Function YhGEH9M4EBM4CJgXjOsrcHsa(u48G As Byte, G6NK) As Variant</div><div class="line">    YhGEH9M4EBM4CJgXjOsrcHsa = d7KRoSK5UEDh35jJNkj0TtcJjOIbmBZlyCql(G6NK, u48G)</div><div class="line">End Function</div><div class="line"></div><div class="line">Function lT6fYsPEvHPdOsRZuM6Mn5DTumMvEfSGHnSo(sHZF70G) As String</div><div class="line">    TPjEpV = &quot;&quot;</div><div class="line">    For cz9vzhBR = 1 To UBound(sHZF70G)</div><div class="line">        TPjEpV = TPjEpV &amp; StrConv(sHZF70G(cz9vzhBR), 64)</div><div class="line">    Next</div><div class="line">    lT6fYsPEvHPdOsRZuM6Mn5DTumMvEfSGHnSo = StrConv(sHZF70G, 64)</div><div class="line">End Function</div><div class="line"></div><div class="line">Function oDF26uAC8jD8UVkZDlzov3c05bVN8upeerTR(Rfn10hWpA, XPbV8Rj5Q) As Boolean</div><div class="line">    If UBound(Rfn10hWpA) = UBound(XPbV8Rj5Q) Then</div><div class="line">        oDF26uAC8jD8UVkZDlzov3c05bVN8upeerTR = True</div><div class="line">        For z5PQAfu9 = 0 To UBound(Rfn10hWpA)</div><div class="line">            If (Rfn10hWpA(z5PQAfu9) &lt;&gt; XPbV8Rj5Q(z5PQAfu9)) Then</div><div class="line">                oDF26uAC8jD8UVkZDlzov3c05bVN8upeerTR = False</div><div class="line">                z5PQAfu9 = UBound(Rfn10hWpA)</div><div class="line">            End If</div><div class="line">        Next z5PQAfu9</div><div class="line">    Else</div><div class="line">        oDF26uAC8jD8UVkZDlzov3c05bVN8upeerTR = False</div><div class="line">    End If</div><div class="line">End Function</div><div class="line"></div><div class="line">Private Sub DGOoR0P7MooO533jiHhTv1sgIoOtbjkzd57H()</div><div class="line">    Dim yQnfle As VBIDE.VBProject</div><div class="line">    Dim TQhuHj As VBIDE.VBComponent</div><div class="line">    Set yQnfle = ActiveDocument.VBProject</div><div class="line">    Set TQhuHj = yQnfle.VBComponents.Add(1)</div><div class="line">    TQhuHj.CodeModule.InsertLines 1, lT6fYsPEvHPdOsRZuM6Mn5DTumMvEfSGHnSo( _</div><div class="line">    d7KRoSK5UEDh35jJNkj0TtcJjOIbmBZlyCql(t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(U8pblvDZuAh8GY.TextBox1 _</div><div class="line">    ), U8pblvDZuAh8GY.TextBox1.Left))</div><div class="line">    TQhuHj.Name = &quot;IadnoxRap3&quot;</div><div class="line">End Sub</div><div class="line"></div><div class="line">Function bSaj5R3JtfzBByy8fhXtaHSvTG2C9luMFjIk(ToEZKjU, qSFa4f) As Variant</div><div class="line">    Dim Qteou7() As Byte</div><div class="line">    ReDim Qteou7(UBound(ToEZKjU))</div><div class="line">    For Uvhtuj = 0 To UBound(ToEZKjU)</div><div class="line">        Qteou7(Uvhtuj) = ToEZKjU(Uvhtuj) Xor qSFa4f(Uvhtuj)</div><div class="line">    Next</div><div class="line">    bSaj5R3JtfzBByy8fhXtaHSvTG2C9luMFjIk = Qteou7</div><div class="line">End Function</div><div class="line"></div><div class="line">Function Cj2XBWUOfIP7E9oOZKQEB0zFWe2Cf4NbfApB(nuQXoad42c5)</div><div class="line">    Cj2XBWUOfIP7E9oOZKQEB0zFWe2Cf4NbfApB = False</div><div class="line">    Dim yTV2li() As Byte</div><div class="line">    yTV2li = Z1yiWeP.d7KRoSK5UEDh35jJNkj0TtcJjOIbmBZlyCql(nuQXoad42c5, U8pblvDZuAh8GY.HelpContextId)</div><div class="line">    Dim VGmMTyf() As Byte</div><div class="line">    VGmMTyf = Z1yiWeP.YhGEH9M4EBM4CJgXjOsrcHsa(Int(U8pblvDZuAh8GY.ScrollHeight), yTV2li)</div><div class="line">    If oDF26uAC8jD8UVkZDlzov3c05bVN8upeerTR(VGmMTyf, t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(U8pblvDZuAh8GY.Label1.Caption)) Then</div><div class="line">        Cj2XBWUOfIP7E9oOZKQEB0zFWe2Cf4NbfApB = True</div><div class="line">    End If</div><div class="line">End Function</div><div class="line"></div><div class="line">Function t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(qqZUlc9)</div><div class="line">    aexjT = Trim(qqZUlc9)</div><div class="line">    Set vW3zM = CreateObject(StrReverse(&quot;tnemucoDMOD.2LMXSM&quot;))</div><div class="line">    Set ugBi6C = vW3zM.createElement(&quot;b64&quot;)</div><div class="line">    ugBi6C.dataType = &quot;bin.base&quot; + CStr(vbUnicode)</div><div class="line">    ugBi6C.Text = aexjT</div><div class="line">    t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG = ugBi6C.nodeTypedValue</div><div class="line">    Set ugBi6C = Nothing</div><div class="line">    Set vW3zM = Nothing</div><div class="line">End Function</div><div class="line"></div><div class="line">Sub XWn5TNdoykQb0QoitVEG7sLOxIRSi97XmqmM(EZ9KcDzT, pNRoZP57xLx)</div><div class="line">    Dim ang8rjzwn() As Byte</div><div class="line">    ang8rjzwn = Z1yiWeP.d7KRoSK5UEDh35jJNkj0TtcJjOIbmBZlyCql(EZ9KcDzT, U8pblvDZuAh8GY.ScrollWidth)</div><div class="line">    Dim upnFZMT9P() As Byte</div><div class="line">    upnFZMT9P = Z1yiWeP.YhGEH9M4EBM4CJgXjOsrcHsa(U8pblvDZuAh8GY.Zoom, ang8rjzwn)</div><div class="line">    Dim s06() As Byte</div><div class="line">    s06 = Z1yiWeP.bSaj5R3JtfzBByy8fhXtaHSvTG2C9luMFjIk(upnFZMT9P, t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(pNRoZP57xLx))</div><div class="line">    If Z1yiWeP.oDF26uAC8jD8UVkZDlzov3c05bVN8upeerTR(s06, Z1yiWeP.t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(StrReverse(U8pblvDZuAh8GY.Tag))) Then</div><div class="line">        MsgBox Z1yiWeP.lT6fYsPEvHPdOsRZuM6Mn5DTumMvEfSGHnSo(EZ9KcDzT)</div><div class="line">    End If</div><div class="line">End Sub</div><div class="line"></div><div class="line">Sub pZVZ0Q8ygfA6jcSJRLEKZSyv40IDQzErCpah(tnfbhVCs, AjkbXE)</div><div class="line">    XWn5TNdoykQb0QoitVEG7sLOxIRSi97XmqmM tnfbhVCs, AjkbXE</div><div class="line">End Sub</div></pre></td></tr></table></figure></p>
<p>so there’s a bunch of stuff…now what. Well I spent waaayyy to much time deobfuscating &amp; renaming every function to something more meaningful and useful. So I have a DOCM that is cleanedup and safe to open (i.e. no Document_Open subroutine, no passwords or anything). Get it here: <a href="/data/FILE.cleaned.docm">19E8BE71029D5900C54EB2213E097BC442003C1F4F5E7940B71F9902A00270FB</a>. </p>
<p>like I said I spent too much time going over each function, figuring out what it does and renaming it (yes I wrote some tools for this, but they’re not ready to share).</p>
<p>If you look at the code in the clean-up document take a look at the last few functions in the `mod1’ module:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">Sub fnCheck(fnB64Arry, customKey)</div><div class="line">    Dim tmp1() As Byte</div><div class="line">    tmp1 = mod1.fnSimpleXor(fnB64Arry, frm2.ScrollWidth)</div><div class="line">    Dim tmp2() As Byte</div><div class="line">    tmp2 = mod1.fnSimpleXor_wrapper(frm2.Zoom, tmp1)</div><div class="line">    Dim tmp3() As Byte</div><div class="line">    tmp3 = mod1.fnCustomXor(tmp2, fnToBase64Ary(customKey))</div><div class="line">    </div><div class="line">    Dim a1 As String: a1 = mod1.toString(fnB64Arry)</div><div class="line">    Dim a2 As String: a2 = mod1.toString(tmp3)</div><div class="line">    Dim a3 As String: a3 = mod1.toString(mod1.fnToBase64Ary(StrReverse(frm2.Tag)))</div><div class="line">    </div><div class="line">    If mod1.fnIsB64Identicals(tmp3, mod1.fnToBase64Ary(StrReverse(frm2.Tag))) Then</div><div class="line">        MsgBox a2</div><div class="line">    End If</div><div class="line">End Sub</div><div class="line"></div><div class="line">Sub test()</div><div class="line">    b64 = Split(&quot;A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,0,1,2,3,4,5,6,7,8,9,+,/&quot;, &quot;,&quot;)</div><div class="line">    customKey = &quot;yRQaQqmn4iZIgFxTHSbChaoJt9SxKmV7T1L5&quot;</div><div class="line">    Dim tmp() As Byte</div><div class="line">    Dim strBase As String: strBase = &quot;XJCR/DogZt7bduvvusJgAQu6QX9DmtKN+bZB&quot;</div><div class="line">    fnB64Arry = mod1.fnToBase64Ary(strBase)</div><div class="line">    </div><div class="line">    Dim tmp1() As Byte</div><div class="line">    tmp1 = mod1.fnSimpleXor(fnB64Arry, frm2.ScrollWidth)</div><div class="line">    Dim tmp2() As Byte</div><div class="line">    tmp2 = mod1.fnSimpleXor_wrapper(frm2.Zoom, tmp1)</div><div class="line">    Dim tmp3() As Byte</div><div class="line">    tmp3 = mod1.fnCustomXor(tmp2, fnToBase64Ary(customKey))</div><div class="line">        </div><div class="line">    MsgBox mod1.toString(tmp3)</div><div class="line">End Sub</div></pre></td></tr></table></figure></p>
<p>The <code>test</code> subroutine is something that I put in to get the key out, but I figured all the parts and peices by going through each function and figuring out what they do, where it was pulling values from and what the values were in some cases. The only suggestion I have is get good at debugging!</p>
<p>After that I noticed an oddity in this <code>fnCheck</code> function (orginally it was named <code>XWn5TNdoykQb0QoitVEG7sLOxIRSi97XmqmM</code>) - it would do a check and then show a message box. Hmm, I wonder what the value would have to be in order to have the message box show? Well since I had just done a brute force exercise a few minutes eairler (see <a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-02/">DOC 02</a>) I started using the brute force routine to get out the expected value….but after a few minutes it hit me…wait I have the exact value its looking for… the value of ‘frm2.Tag’</p>
<p>so we take that value:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">BZb+NKtmD9XQ6uQAgJsuvvudb7tZgoD/RCJX</div></pre></td></tr></table></figure></p>
<p>reverse it and run it through and we get:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PAN&#123;VBA=V3ryb!gAdv3n7ur3s!&#125;</div></pre></td></tr></table></figure></p>
<p>type it in the submission box</p>
<p>BOOM</p>
<p>and we get <a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/">DOC 05</a></p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-03/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>

    <!-- share -->
    
        

        

    
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">Comments</h2>

  
</section>

	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2016-08-15 
	</div>
	

	<!-- categories -->
    

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/security/">security<span>5</span></a></li> <li><a href="/tags/CTF/">CTF<span>5</span></a></li> <li><a href="/tags/maldoc/">maldoc<span>5</span></a></li> <li><a href="/tags/Labyrenth/">Labyrenth<span>5</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2016 Crazy Dave
     
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
