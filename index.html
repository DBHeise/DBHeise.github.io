<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Crazy Dave&#39;s InterTube Emporium</title>
  <meta name="author" content="Crazy Dave">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Crazy Dave&#39;s InterTube Emporium"/>

  
    <meta property="og:image" content="undefined"/>
  

  
    <link rel="alternative" href="/atom.xml" title="Crazy Dave&#39;s InterTube Emporium" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/cyborg.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">Crazy Dave&#39;s InterTube Emporium</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/projects" title="Past, Present, and Future Projects">
			  <i class="folder"></i>Projects
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header page-header-inverse ">
  <h1 class="title title-inverse ">where stuff goes to the corner</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      now think about what you&#39;ve done
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
        <!-- render top articles firstly -->
        
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
        
        <!-- render other articles -->
        
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-01-22 </div>
			<div class="article-title"><a href="/2018/01/22/New-HTML-Experiments/" >New HTML Experiments</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>So I’ve recently had a few automation random ideas. The problem was that it was such a small automation and I wanted it to be useable anywhere, so I wrote it in a single HTML page and the code is in Javascript.</p>
<ul>
<li><a href="/projects/svgpath.html">SVG Path Cleaner</a> - changes all the numbers in a SVG path to be decimal (i.e. rounds the number)</li>
<li><a href="/projects/randompath.html">Random SVG Page</a> - creates a small random SVG path</li>
</ul>

	
	</div>
  <a type="button" href="/2018/01/22/New-HTML-Experiments/#more" class="btn btn-default more">Read More</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-08-21 </div>
			<div class="article-title"><a href="/2016/08/21/My-First-ScreenSaver-an-obsession-in-VB6/" >My First ScreenSaver - an obsession in VB6</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p>So back when I first started writing code, I was had this obsession with screen savers. I don’t really know why but I loved screen savers that were not repetitive, ones that changed over time and did something. Like any of the following:</p>
<ul>
<li>Johnny Castaway by Sierra Online - <a href="http://web.onetel.net.uk/~gnudawn/johnny/" target="_blank" rel="noopener">best writeup</a>, <a href="https://en.wikipedia.org/wiki/Johnny_Castaway" target="_blank" rel="noopener">wikipedia</a></li>
<li>the After Dark series by Berkeley Systems -  <a href="https://en.wikipedia.org/wiki/After_Dark_%28software%29" target="_blank" rel="noopener">wikipedia</a></li>
<li><a href="http://setiathome.ssl.berkeley.edu/" target="_blank" rel="noopener">SETI@home</a></li>
<li><a href="http://www.worldcommunitygrid.org" target="_blank" rel="noopener">World Community Grid</a></li>
<li>Various Santa Clause antic’s screen savers</li>
<li>Various Fish Tank screen savers</li>
</ul>
<p>…and my personal favorite:</p>
<ul>
<li><a href="http://www.staircasestudio.com/cnc/scombat.htm" target="_blank" rel="noopener">Space Combat</a> by Philip Williams</li>
</ul>
<p>but nowadays I don’t download screen savers unless I can compile from source…</p>
<p>anyways, at one time I attempted to create my own in VB (why VB…well that’s a post in itself) based on the Space Combat screen saver, but I didn’t have fancy graphics. So I used basic sprites and freely available images found on various corners of the InterTubes:</p>

<table><tr>
<td><img alt="AGX-04" src="/data/images/bismark/AGX-04.png"></td>
<td><img alt="Deathstar" src="/data/images/bismark/Deathstar.png"></td>
<td><img alt="Easter Bunny" src="/data/images/bismark/Easter Bunny.png"></td>
<td><img alt="Ghost 2" src="/data/images/bismark/Ghost 2.png"></td>
<td><img alt="H2o" src="/data/images/bismark/H2o.png"></td>
<td><img alt="Happy Face" src="/data/images/bismark/Happy Face.png"></td>
<td><img alt="Hitchhiker's Guy" src="/data/images/bismark/Hitchhiker's Guy.png"></td>
<td><img alt="LOMPSTER" src="/data/images/bismark/LOMPSTER.png"></td>
<td><img alt="M Falcon" src="/data/images/bismark/M Falcon.png"></td>
<td><img alt="MA-04X" src="/data/images/bismark/MA-04X.png"></td>
<td><img alt="Pac Ghost" src="/data/images/bismark/Pac Ghost.png"></td>
<td><img alt="Radish" src="/data/images/bismark/Radish.png"></td>
<td><img alt="RB-79" src="/data/images/bismark/RB-79.png"></td>
<td><img alt="Slave 1" src="/data/images/bismark/Slave 1.png"></td>
<td><img alt="Space Ship" src="/data/images/bismark/Space Ship.png"></td>
<td><img alt="Sunburst" src="/data/images/bismark/Sunburst.png"></td>
</tr></table>

<p>If you want to take a look you can <a href="/data/Bismark.zip">download it</a>, or <a href="/data/Bismark.7z">with the VB source</a></p>

	
	</div>
  <a type="button" href="/2016/08/21/My-First-ScreenSaver-an-obsession-in-VB6/#more" class="btn btn-default more">Read More</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-08-15 </div>
			<div class="article-title"><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/" >2016 Palo Alto Labyrenth CTF Doc 05</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<ul>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-01/">DOC 01</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-02/">DOC 02</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-03/">DOC 03</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-04/">DOC 04</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/">DOC 05</a> &lt;- You are here</li>
</ul>
<p>Again the fifth challenge is a zip file: <a href="/data/PAN_CTF_DOCTrack_005.zip">01E1B7BCFB39B4A666475991AF11C5762A489F9395C48B4E156526E1C6E4573F</a></p>
<p>But I have to first admit that I solved this one third, not fifth…in fact I got a message when I tried to submit the fifth challenge solution early that I had to do them in order. How did I do them out of order you ask? well remember in the very first document there was an extra <code>.7z</code> file inside the zip. This was a 7Zip archive that contained ALL of the challenges (go look for yourself).</p>
<p>So running it through <a href="https://github.com/DBHeise/fileid" target="_blank" rel="noopener">FileId</a> showed only a little bit of macros:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Sub excelulate()</span><br><span class="line"></span><br><span class="line">    Application.Quit</span><br><span class="line"></span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure></p>
<p>So I crack the file open in Microsoft Excel….hmmm its only asking for a value and a button. You click the button and it says you stink and opens calc.exe. Wait what? there’s no macro’s how is this happening? So I open the file in eDoc. What is eDoc you say? its a GUI application for looking at the streams and folders inside an Ole Structured Storage container. I don’t have a link for it as the company that produced it no longer exists, but I still have the binary…besides a very similar tool is <a href="http://www.mitec.cz/ssv.html" target="_blank" rel="noopener">SSView</a> by MiTec (in fact is in many ways better…but eDoc lets me search for hex/ascii values and do inline editing).</p>
<p>So perusing through the hex view of the <code>Workbook</code> stream (i.e. where the actual workbooks live) we can easily see calc.exe (around stream offset 0x5b90 as well as other places) and several other strings that were NOT on the three sheets when we opened Excel eariler….HIDDEN SHEETS.</p>
<p>So open up excel, right click on and of the sheet names and click <code>unhide</code>…a little dialog opens up and we can unhide the <code>secret</code> sheet. But wait it looks empty. So we start looking through the formula values and eventually you will find cell A14 with this formula:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=IF(RUN(supersecret!F13))</span><br></pre></td></tr></table></figure></p>
<p>So here you need to know excel forumlas and you will see that the notation they’re using shows there is ANOTHER hidden sheet. what? how can this be you ask? well turns out that excel has something called a VeryHidden sheet (see <a href="https://support.microsoft.com/en-us/kb/213609" target="_blank" rel="noopener">KB213609</a>, or just search the InterTubes yourself)</p>
<p>Hmmm, so how do we unhide a very hidden sheet? well just fix it in VBA. So there’s already a function <code>excelulate</code> so I simply changed it to:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sub excelulate()</span><br><span class="line">    ActiveWorkbook.Sheets(&quot;supersecret&quot;).Visible = True</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>
<p>and then run it!</p>
<p>so we look at the newly discovered sheet and we find the crazy formula in F13:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=RETURN(EXACT(CONCATENATE(D7,A5,C5,B4,E20,B6,A8,B8,A12,B10,E10,C9,B13,D12,C11,B16,A25,A18,B19,C20,B21,B2,D23,B24,E4,B26,D16,A21,C14,A16),Sheet1!B3))</span><br></pre></td></tr></table></figure></p>
<p>So I copy this into another cell in the same sheet, but modifiy at so:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=CONCATENATE(D7,A5,C5,B4,E20,B6,A8,B8,A12,B10,E10,C9,B13,D12,C11,B16,A25,A18,B19,C20,B21,B2,D23,B24,E4,B26,D16,A21,C14,A16)</span><br></pre></td></tr></table></figure></p>
<p>but wait it doesn’t run it! this sheet is showing the forumlas instead of running them. No problem, I go back to the <code>Sheet1</code> sheet and pick an empty cell and enter the formula:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=supersecret!F16</span><br></pre></td></tr></table></figure></p>
<p>and poof! we have this value:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PAN&#123;Exc3l4=3x7r3me1y4An7a5+!c&#125;</span><br></pre></td></tr></table></figure></p>
<p>we enter it into the CTF dialog</p>
<p>BOOM</p>
<p>completed!</p>

	
	</div>
  <a type="button" href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/#more" class="btn btn-default more">Read More</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-08-15 </div>
			<div class="article-title"><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-04/" >2016 Palo Alto Labyrenth CTF Doc 04</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<ul>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-01/">DOC 01</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-02/">DOC 02</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-03/">DOC 03</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-04/">DOC 04</a> &lt;- You are here</li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/">DOC 05</a> </li>
</ul>
<p>Ok, so the fourth challenge is again a zip file (hash: 1A2570D5CC6E2C3A185E939DC49CB4B908B867E02AC84BF7ABB532B3395FB01A) and it contains a file fun.docm (hash: <a href="/data/PAN_CTF_DOCTrack_004.zip">4AE794A701D2F28BA7E6292F0463444F6A567CB7C26188A518270544252877FB</a>). Now the first thing you need to know about the newer office file formats is that they are all zip files. So yes a DOCM and a XLSX and a PPTX, etc are all ZIP files with various contents pieces inside (see <a href="https://github.com/DBHeise/fileid/wiki/zip" target="_blank" rel="noopener">here</a> for other zip based documents)</p>
<p>SIDENOTE: this is one of the very reasons that I wrote my <a href="https://github.com/DBHeise/fileid" target="_blank" rel="noopener">FileId</a> tool to begin with. Most file identification apps don’t go very much beyond magic headers. If we understand that the magic header gives us a container format (i.e. Ole Structured Storage [OLESS], ZIP, and many others), then we can parse that container and gain much more information. This is exactly what FileId does it understands OLESS files and ZIP files and has some ideas what to look for inside to figure out its true file type.</p>
<p>SIDE-SIDENOTE: Of course since its a container then we can do nasty things that were never intended to be done…like having a DOC, XLS, PPT all in a single file and all open completely different content depending on which app is opening it.</p>
<p>ok, back to the challenge at hand and DOCM file! we can verify its a DOCM by running it through <a href="https://github.com/DBHeise/fileid" target="_blank" rel="noopener">FileId</a> or we can simply run 7zip and extract the contents…which is what I did. Since its truly a DOCM we will find a file inside the <code>WORD</code> subfolder named <code>vbaProject.bin</code> (it actually doesn’t have to be named this, but I digress). I also happen to know that this is also an OLESS file, so again we can run it through <a href="https://github.com/DBHeise/fileid" target="_blank" rel="noopener">FileId</a>, but there is a known bug in <a href="https://github.com/DBHeise/fileid" target="_blank" rel="noopener">FileId</a> here…</p>
<p>So here we have a couple of choices as what to do next, but the underlying principle is to get to the VBA…here are several options (I did them all):</p>
<ol>
<li>use olevba.py in <a href="http://www.decalage.info/python/oletools" target="_blank" rel="noopener">OleTools</a> by Philippe Lagadec</li>
<li>use the office object model to open and save the file in the DOC format (won’t run macro, but will maintain them)</li>
<li>unzip the DOCM, edit the <code>vbaProject.bin</code> to remove the  protections and alter the autorun functionname (how to do this will be covered in the <a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/">DOC 05</a> writeup)</li>
</ol>
<p>So lets assume you did one of those, you’d get the following macro parts:</p>
<p>=ThisDocument=<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">#If VBA7 And Win64 Then</span><br><span class="line">Private Declare PtrSafe Function jFlnz8 Lib &quot;winmm.dll&quot; Alias &quot;sndPlaySoundA&quot; _</span><br><span class="line">       (ByVal lpszSoundName As String, ByVal uFlags As Long) As Long</span><br><span class="line">#Else</span><br><span class="line">Private Declare Function jFlnz8 Lib &quot;winmm.dll&quot; Alias &quot;sndPlaySoundA&quot; _</span><br><span class="line">       (ByVal lpszSoundName As String, ByVal uFlags As Long) As Long</span><br><span class="line">#End If</span><br><span class="line"></span><br><span class="line">Public cMSuxt As Variant</span><br><span class="line">Public gkKg As Object</span><br><span class="line">Public cN3r As String</span><br><span class="line">Public kZ4gU8sc As String</span><br><span class="line">Public qa317 As Integer</span><br><span class="line"></span><br><span class="line">Sub znOIKcDsLlMKQVsnFfWaE2bHu18RdOmKFoVb()</span><br><span class="line">    Selection.WholeStory</span><br><span class="line">    Selection.Font.ColorIndex = (Selection.Font.ColorIndex + 1) Mod 15</span><br><span class="line">    If Selection.Font.ColorIndex Mod 2 = 0 Then</span><br><span class="line">        Set gkKg = CreateObject(&quot;Excel.Application&quot;)</span><br><span class="line">        gkKg.Speech.speak NpuXrzgq.Label1, True</span><br><span class="line">        gkKg.Quit</span><br><span class="line">    ElseIf Selection.Font.ColorIndex Mod 2 = 1 Then</span><br><span class="line">        adk49an = Environ(&quot;tmp&quot;) &amp; &quot;\&quot; &amp; &quot;asdf&quot;</span><br><span class="line">        jFlnz8 adk49an, 1</span><br><span class="line">    End If</span><br><span class="line">    Application.OnTime Now + TimeValue(&quot;00:00:01&quot;), &quot;znOIKcDsLlMKQVsnFfWaE2bHu18RdOmKFoVb&quot;</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Private Sub UxKo3LivfGHxI2OtWa3KtqOgY6cRb5yrbR00(m4dYL, fviLw9)</span><br><span class="line">    On Error GoTo NavnYIF0:</span><br><span class="line">    Dim fjGeMmP8Z() As Byte</span><br><span class="line">    fjGeMmP8Z = Z1yiWeP.t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(m4dYL)</span><br><span class="line">    Z1yiWeP.pZVZ0Q8ygfA6jcSJRLEKZSyv40IDQzErCpah fjGeMmP8Z, fviLw9</span><br><span class="line">NavnYIF0:</span><br><span class="line">    GoTo VadXU4</span><br><span class="line">VadXU4:</span><br><span class="line"></span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Private Function BqNFmKCS7cTPv9XNFOd2mCLrdqCfmdNm6HBz(dd) As Boolean</span><br><span class="line">    BqNFmKCS7cTPv9XNFOd2mCLrdqCfmdNm6HBz = False</span><br><span class="line">    On Error GoTo B3A:</span><br><span class="line">    Dim A4xcPiKtrr() As Byte</span><br><span class="line">    A4xcPiKtrr = Z1yiWeP.t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(dd)</span><br><span class="line">    BqNFmKCS7cTPv9XNFOd2mCLrdqCfmdNm6HBz = Z1yiWeP.Cj2XBWUOfIP7E9oOZKQEB0zFWe2Cf4NbfApB(A4xcPiKtrr)</span><br><span class="line">B3A:</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Private Function zoycqKJvqznJMeMpHe7Z61xYJfLLmbObxBVy()</span><br><span class="line">    zoycqKJvqznJMeMpHe7Z61xYJfLLmbObxBVy = None</span><br><span class="line">    For Each ok0I11 In ActiveDocument.VBProject.VBComponents</span><br><span class="line">        l = 1</span><br><span class="line">        Set gjvhSFe = ok0I11.CodeModule</span><br><span class="line">        Do While l &lt; gjvhSFe.CountOfLines</span><br><span class="line">            za29rx = gjvhSFe.ProcOfLine(l, 0)</span><br><span class="line">            If za29rx &lt;&gt; &quot;&quot; Then</span><br><span class="line">                If BqNFmKCS7cTPv9XNFOd2mCLrdqCfmdNm6HBz(za29rx) Then</span><br><span class="line">                    zoycqKJvqznJMeMpHe7Z61xYJfLLmbObxBVy = za29rx</span><br><span class="line">                    GoTo CfHFE</span><br><span class="line">                End If</span><br><span class="line">                l = l + gjvhSFe.ProcCountLines(za29rx, 0)</span><br><span class="line">            Else</span><br><span class="line">                l = l + 1</span><br><span class="line">            End If</span><br><span class="line">        Loop</span><br><span class="line">    Next ok0I11</span><br><span class="line">CfHFE:</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Private Sub XiqyXdC809pP5esSrC633ag92w0x6otQylY0()</span><br><span class="line">    sN2l0P = zoycqKJvqznJMeMpHe7Z61xYJfLLmbObxBVy</span><br><span class="line">    If Not IsNull(sN2l0P) Then</span><br><span class="line">        For Each LHKwfvbUC In ActiveDocument.VBProject.VBComponents</span><br><span class="line">            If LHKwfvbUC.Type = 1 Then</span><br><span class="line">                HKwfvbU = 1</span><br><span class="line">                Set cm = LHKwfvbUC.CodeModule</span><br><span class="line">                Do While HKwfvbU &lt; cm.CountOfLines</span><br><span class="line">                    pn = cm.ProcOfLine(HKwfvbU, 0)</span><br><span class="line">                    If pn &lt;&gt; &quot;&quot; Then</span><br><span class="line">                        UxKo3LivfGHxI2OtWa3KtqOgY6cRb5yrbR00 pn, sN2l0P</span><br><span class="line">                        HKwfvbU = HKwfvbU + cm.ProcCountLines(pn, 0)</span><br><span class="line">                    Else</span><br><span class="line">                        HKwfvbU = HKwfvbU + 1</span><br><span class="line">                    End If</span><br><span class="line">                Loop</span><br><span class="line">            End If</span><br><span class="line">        Next LHKwfvbUC</span><br><span class="line">    End If</span><br><span class="line">    zkceuV405Q5LjUp587OYxTI7OR9zTyPdvz8k</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Private Function OcbCTRJiqmq8ZHdtwfA1hsuje7UPUwkL1TcL(e2qBnJA1D, GNheMViA)</span><br><span class="line">    df = Environ(&quot;tmp&quot;) &amp; &quot;\&quot; &amp; e2qBnJA1D</span><br><span class="line">    Dim CiuxGXWXyEUw4() As Byte</span><br><span class="line">    CiuxGXWXyEUw4 = Z1yiWeP.t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(GNheMViA)</span><br><span class="line">    Open df For Binary Access Write As #1</span><br><span class="line">    Put #1, , CiuxGXWXyEUw4</span><br><span class="line">    Close #1</span><br><span class="line">    OcbCTRJiqmq8ZHdtwfA1hsuje7UPUwkL1TcL = df</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Private Sub zkceuV405Q5LjUp587OYxTI7OR9zTyPdvz8k()</span><br><span class="line">    yRQaQqmn4iZIgFxTHSbChaoJt9SxKmV7T1L5</span><br><span class="line">    Selection.WholeStory</span><br><span class="line">    Selection.Delete</span><br><span class="line">    Selection.TypeText NpuXrzgq.Label1</span><br><span class="line">    Selection.WholeStory</span><br><span class="line">    Selection.Font.Size = 72</span><br><span class="line">    znOIKcDsLlMKQVsnFfWaE2bHu18RdOmKFoVb</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Private Sub yRQaQqmn4iZIgFxTHSbChaoJt9SxKmV7T1L5()</span><br><span class="line">    cMSuxt = Array(OcbCTRJiqmq8ZHdtwfA1hsuje7UPUwkL1TcL(&quot;asdf&quot;, NpuXrzgq.assda))</span><br><span class="line">    kZ4gU8sc = NpuXrzgq.Label1</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Public Sub Document_Open()</span><br><span class="line">    On Error GoTo sjjQMD:</span><br><span class="line">    If ActiveDocument.VBProject.VBComponents.Count &gt; 4 Then</span><br><span class="line">        XiqyXdC809pP5esSrC633ag92w0x6otQylY0</span><br><span class="line">    Else</span><br><span class="line">        zkceuV405Q5LjUp587OYxTI7OR9zTyPdvz8k</span><br><span class="line">    End If</span><br><span class="line">sjjQMD:</span><br><span class="line">    If err.Number = 6068 Or err.Number = 50289 Then</span><br><span class="line">        zkceuV405Q5LjUp587OYxTI7OR9zTyPdvz8k</span><br><span class="line">    Else</span><br><span class="line">        Resume Next</span><br><span class="line">    End If</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure></p>
<p>=Z1yiWeP=<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">Attribute VB_Name = &quot;Z1yiWeP&quot;</span><br><span class="line">Function d7KRoSK5UEDh35jJNkj0TtcJjOIbmBZlyCql(JwFeyAb5x, AgkWcn As Byte) As Variant</span><br><span class="line">    Dim bzTec() As Byte</span><br><span class="line">    ReDim bzTec(UBound(JwFeyAb5x))</span><br><span class="line">    For cz9vzhBR = 0 To UBound(JwFeyAb5x)</span><br><span class="line">        bzTec(cz9vzhBR) = JwFeyAb5x(cz9vzhBR) Xor AgkWcn</span><br><span class="line">    Next</span><br><span class="line">    d7KRoSK5UEDh35jJNkj0TtcJjOIbmBZlyCql = bzTec</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Private Sub ir0a6FeeF0LUThieRM7v6qxfWFJD1dT6BzDH()</span><br><span class="line">    Dim opy7ej As VBIDE.VBProject</span><br><span class="line">    Dim PiO3rcWe As VBIDE.VBComponent</span><br><span class="line">    Set opy7ej = ActiveDocument.VBProject</span><br><span class="line">    Set PiO3rcWe = opy7ej.VBComponents(&quot;IadnoxRap3&quot;)</span><br><span class="line">    opy7ej.VBComponents.Remove PiO3rcWe</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Function YhGEH9M4EBM4CJgXjOsrcHsa(u48G As Byte, G6NK) As Variant</span><br><span class="line">    YhGEH9M4EBM4CJgXjOsrcHsa = d7KRoSK5UEDh35jJNkj0TtcJjOIbmBZlyCql(G6NK, u48G)</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Function lT6fYsPEvHPdOsRZuM6Mn5DTumMvEfSGHnSo(sHZF70G) As String</span><br><span class="line">    TPjEpV = &quot;&quot;</span><br><span class="line">    For cz9vzhBR = 1 To UBound(sHZF70G)</span><br><span class="line">        TPjEpV = TPjEpV &amp; StrConv(sHZF70G(cz9vzhBR), 64)</span><br><span class="line">    Next</span><br><span class="line">    lT6fYsPEvHPdOsRZuM6Mn5DTumMvEfSGHnSo = StrConv(sHZF70G, 64)</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Function oDF26uAC8jD8UVkZDlzov3c05bVN8upeerTR(Rfn10hWpA, XPbV8Rj5Q) As Boolean</span><br><span class="line">    If UBound(Rfn10hWpA) = UBound(XPbV8Rj5Q) Then</span><br><span class="line">        oDF26uAC8jD8UVkZDlzov3c05bVN8upeerTR = True</span><br><span class="line">        For z5PQAfu9 = 0 To UBound(Rfn10hWpA)</span><br><span class="line">            If (Rfn10hWpA(z5PQAfu9) &lt;&gt; XPbV8Rj5Q(z5PQAfu9)) Then</span><br><span class="line">                oDF26uAC8jD8UVkZDlzov3c05bVN8upeerTR = False</span><br><span class="line">                z5PQAfu9 = UBound(Rfn10hWpA)</span><br><span class="line">            End If</span><br><span class="line">        Next z5PQAfu9</span><br><span class="line">    Else</span><br><span class="line">        oDF26uAC8jD8UVkZDlzov3c05bVN8upeerTR = False</span><br><span class="line">    End If</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Private Sub DGOoR0P7MooO533jiHhTv1sgIoOtbjkzd57H()</span><br><span class="line">    Dim yQnfle As VBIDE.VBProject</span><br><span class="line">    Dim TQhuHj As VBIDE.VBComponent</span><br><span class="line">    Set yQnfle = ActiveDocument.VBProject</span><br><span class="line">    Set TQhuHj = yQnfle.VBComponents.Add(1)</span><br><span class="line">    TQhuHj.CodeModule.InsertLines 1, lT6fYsPEvHPdOsRZuM6Mn5DTumMvEfSGHnSo( _</span><br><span class="line">    d7KRoSK5UEDh35jJNkj0TtcJjOIbmBZlyCql(t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(U8pblvDZuAh8GY.TextBox1 _</span><br><span class="line">    ), U8pblvDZuAh8GY.TextBox1.Left))</span><br><span class="line">    TQhuHj.Name = &quot;IadnoxRap3&quot;</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Function bSaj5R3JtfzBByy8fhXtaHSvTG2C9luMFjIk(ToEZKjU, qSFa4f) As Variant</span><br><span class="line">    Dim Qteou7() As Byte</span><br><span class="line">    ReDim Qteou7(UBound(ToEZKjU))</span><br><span class="line">    For Uvhtuj = 0 To UBound(ToEZKjU)</span><br><span class="line">        Qteou7(Uvhtuj) = ToEZKjU(Uvhtuj) Xor qSFa4f(Uvhtuj)</span><br><span class="line">    Next</span><br><span class="line">    bSaj5R3JtfzBByy8fhXtaHSvTG2C9luMFjIk = Qteou7</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Function Cj2XBWUOfIP7E9oOZKQEB0zFWe2Cf4NbfApB(nuQXoad42c5)</span><br><span class="line">    Cj2XBWUOfIP7E9oOZKQEB0zFWe2Cf4NbfApB = False</span><br><span class="line">    Dim yTV2li() As Byte</span><br><span class="line">    yTV2li = Z1yiWeP.d7KRoSK5UEDh35jJNkj0TtcJjOIbmBZlyCql(nuQXoad42c5, U8pblvDZuAh8GY.HelpContextId)</span><br><span class="line">    Dim VGmMTyf() As Byte</span><br><span class="line">    VGmMTyf = Z1yiWeP.YhGEH9M4EBM4CJgXjOsrcHsa(Int(U8pblvDZuAh8GY.ScrollHeight), yTV2li)</span><br><span class="line">    If oDF26uAC8jD8UVkZDlzov3c05bVN8upeerTR(VGmMTyf, t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(U8pblvDZuAh8GY.Label1.Caption)) Then</span><br><span class="line">        Cj2XBWUOfIP7E9oOZKQEB0zFWe2Cf4NbfApB = True</span><br><span class="line">    End If</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Function t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(qqZUlc9)</span><br><span class="line">    aexjT = Trim(qqZUlc9)</span><br><span class="line">    Set vW3zM = CreateObject(StrReverse(&quot;tnemucoDMOD.2LMXSM&quot;))</span><br><span class="line">    Set ugBi6C = vW3zM.createElement(&quot;b64&quot;)</span><br><span class="line">    ugBi6C.dataType = &quot;bin.base&quot; + CStr(vbUnicode)</span><br><span class="line">    ugBi6C.Text = aexjT</span><br><span class="line">    t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG = ugBi6C.nodeTypedValue</span><br><span class="line">    Set ugBi6C = Nothing</span><br><span class="line">    Set vW3zM = Nothing</span><br><span class="line">End Function</span><br><span class="line"></span><br><span class="line">Sub XWn5TNdoykQb0QoitVEG7sLOxIRSi97XmqmM(EZ9KcDzT, pNRoZP57xLx)</span><br><span class="line">    Dim ang8rjzwn() As Byte</span><br><span class="line">    ang8rjzwn = Z1yiWeP.d7KRoSK5UEDh35jJNkj0TtcJjOIbmBZlyCql(EZ9KcDzT, U8pblvDZuAh8GY.ScrollWidth)</span><br><span class="line">    Dim upnFZMT9P() As Byte</span><br><span class="line">    upnFZMT9P = Z1yiWeP.YhGEH9M4EBM4CJgXjOsrcHsa(U8pblvDZuAh8GY.Zoom, ang8rjzwn)</span><br><span class="line">    Dim s06() As Byte</span><br><span class="line">    s06 = Z1yiWeP.bSaj5R3JtfzBByy8fhXtaHSvTG2C9luMFjIk(upnFZMT9P, t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(pNRoZP57xLx))</span><br><span class="line">    If Z1yiWeP.oDF26uAC8jD8UVkZDlzov3c05bVN8upeerTR(s06, Z1yiWeP.t5ksdVMEuR2gVAPtbKyAxgbL2dy0UBt64qQG(StrReverse(U8pblvDZuAh8GY.Tag))) Then</span><br><span class="line">        MsgBox Z1yiWeP.lT6fYsPEvHPdOsRZuM6Mn5DTumMvEfSGHnSo(EZ9KcDzT)</span><br><span class="line">    End If</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Sub pZVZ0Q8ygfA6jcSJRLEKZSyv40IDQzErCpah(tnfbhVCs, AjkbXE)</span><br><span class="line">    XWn5TNdoykQb0QoitVEG7sLOxIRSi97XmqmM tnfbhVCs, AjkbXE</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure></p>
<p>so there’s a bunch of stuff…now what. Well I spent waaayyy to much time deobfuscating &amp; renaming every function to something more meaningful and useful. So I have a DOCM that is cleanedup and safe to open (i.e. no Document_Open subroutine, no passwords or anything). Get it here: <a href="/data/FILE.cleaned.docm">19E8BE71029D5900C54EB2213E097BC442003C1F4F5E7940B71F9902A00270FB</a>. </p>
<p>like I said I spent too much time going over each function, figuring out what it does and renaming it (yes I wrote some tools for this, but they’re not ready to share).</p>
<p>If you look at the code in the clean-up document take a look at the last few functions in the `mod1’ module:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Sub fnCheck(fnB64Arry, customKey)</span><br><span class="line">    Dim tmp1() As Byte</span><br><span class="line">    tmp1 = mod1.fnSimpleXor(fnB64Arry, frm2.ScrollWidth)</span><br><span class="line">    Dim tmp2() As Byte</span><br><span class="line">    tmp2 = mod1.fnSimpleXor_wrapper(frm2.Zoom, tmp1)</span><br><span class="line">    Dim tmp3() As Byte</span><br><span class="line">    tmp3 = mod1.fnCustomXor(tmp2, fnToBase64Ary(customKey))</span><br><span class="line">    </span><br><span class="line">    Dim a1 As String: a1 = mod1.toString(fnB64Arry)</span><br><span class="line">    Dim a2 As String: a2 = mod1.toString(tmp3)</span><br><span class="line">    Dim a3 As String: a3 = mod1.toString(mod1.fnToBase64Ary(StrReverse(frm2.Tag)))</span><br><span class="line">    </span><br><span class="line">    If mod1.fnIsB64Identicals(tmp3, mod1.fnToBase64Ary(StrReverse(frm2.Tag))) Then</span><br><span class="line">        MsgBox a2</span><br><span class="line">    End If</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Sub test()</span><br><span class="line">    b64 = Split(&quot;A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,0,1,2,3,4,5,6,7,8,9,+,/&quot;, &quot;,&quot;)</span><br><span class="line">    customKey = &quot;yRQaQqmn4iZIgFxTHSbChaoJt9SxKmV7T1L5&quot;</span><br><span class="line">    Dim tmp() As Byte</span><br><span class="line">    Dim strBase As String: strBase = &quot;XJCR/DogZt7bduvvusJgAQu6QX9DmtKN+bZB&quot;</span><br><span class="line">    fnB64Arry = mod1.fnToBase64Ary(strBase)</span><br><span class="line">    </span><br><span class="line">    Dim tmp1() As Byte</span><br><span class="line">    tmp1 = mod1.fnSimpleXor(fnB64Arry, frm2.ScrollWidth)</span><br><span class="line">    Dim tmp2() As Byte</span><br><span class="line">    tmp2 = mod1.fnSimpleXor_wrapper(frm2.Zoom, tmp1)</span><br><span class="line">    Dim tmp3() As Byte</span><br><span class="line">    tmp3 = mod1.fnCustomXor(tmp2, fnToBase64Ary(customKey))</span><br><span class="line">        </span><br><span class="line">    MsgBox mod1.toString(tmp3)</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure></p>
<p>The <code>test</code> subroutine is something that I put in to get the key out, but I figured all the parts and peices by going through each function and figuring out what they do, where it was pulling values from and what the values were in some cases. The only suggestion I have is get good at debugging!</p>
<p>After that I noticed an oddity in this <code>fnCheck</code> function (orginally it was named <code>XWn5TNdoykQb0QoitVEG7sLOxIRSi97XmqmM</code>) - it would do a check and then show a message box. Hmm, I wonder what the value would have to be in order to have the message box show? Well since I had just done a brute force exercise a few minutes eairler (see <a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-02/">DOC 02</a>) I started using the brute force routine to get out the expected value….but after a few minutes it hit me…wait I have the exact value its looking for… the value of ‘frm2.Tag’</p>
<p>so we take that value:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BZb+NKtmD9XQ6uQAgJsuvvudb7tZgoD/RCJX</span><br></pre></td></tr></table></figure></p>
<p>reverse it and run it through and we get:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PAN&#123;VBA=V3ryb!gAdv3n7ur3s!&#125;</span><br></pre></td></tr></table></figure></p>
<p>type it in the submission box</p>
<p>BOOM</p>
<p>and we get <a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/">DOC 05</a></p>

	
	</div>
  <a type="button" href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-04/#more" class="btn btn-default more">Read More</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2016-08-15 </div>
			<div class="article-title"><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-03/" >2016 Palo Alto Labyrenth CTF Doc 03</a></div>						
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<ul>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-01/">DOC 01</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-02/">DOC 02</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-03/">DOC 03</a> &lt;- You are here</li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-04/">DOC 04</a></li>
<li><a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/">DOC 05</a> </li>
</ul>
<p>So we get the third zip file which contains file named “gooby.pdf” (hash:<a href="/data/PAN_CTF_DOCTrack_002.zip">3FB332A27A28AF95187F45D79EC8A08ADEF1A4AAD0D4DDD26B832A15CE9DB91A</a>). Well now we need to turn to PDF tools.</p>
<p>I admit that I’m not as well versed with the internal structures of PDF’s as I am with Office Documents, but their structure is also simplier. So I first tried <a href="https://github.com/dzzie/pdfstreamdumper" target="_blank" rel="noopener">PDFStreamDumper</a> by David Zimmer, but it didn’t see the javascript intially. Then I tried <a href="http://eternal-todo.com/tools/peepdf-pdf-analysis-tool" target="_blank" rel="noopener">peepdf</a>, but again it didn’t get what I needed intially, then I tried the interactive mode and ignoring errors flags:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python peepdf.py -f -l -i goody.pdf</span><br></pre></td></tr></table></figure></p>
<p>So peepdf loads the file, and shows some “stuff”:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">File: gooby.pdf</span><br><span class="line">MD5: 92b562e12560591699e37b6c2533c191</span><br><span class="line">SHA1: ca2250317e4d07a6096282035275256896bcdb2e</span><br><span class="line">SHA256: f575fc6580c192088d60bed8be1791eaa7e5c625331d7c67683f5efb59551247</span><br><span class="line">Size: 119412 bytes</span><br><span class="line">Version: 1.7</span><br><span class="line">Binary: True</span><br><span class="line">Linearized: False</span><br><span class="line">Encrypted: False</span><br><span class="line">Updates: 0</span><br><span class="line">Objects: 11</span><br><span class="line">Streams: 7</span><br><span class="line">URIs: 0</span><br><span class="line">Comments: 0</span><br><span class="line">Errors: 3</span><br><span class="line"></span><br><span class="line">Version 0:</span><br><span class="line">        Catalog: 2</span><br><span class="line">        Info: 4</span><br><span class="line">        Objects (11): [6, 8, 9, 10, 11, 12, 13, 14, 15]</span><br><span class="line">        Streams (7): [11, 12, 13, 14, 15, 9, 12]</span><br><span class="line">                Xref streams (1): [15]</span><br><span class="line">                Encoded (7): [11, 12, 13, 14, 15, 9, 12]</span><br><span class="line">        Objects with JS code (1): [11]</span><br><span class="line">        Suspicious elements:</span><br><span class="line">                /AA (1): [6]</span><br><span class="line">                /JS (1): [11]</span><br><span class="line">                /JavaScript (1): [11]</span><br></pre></td></tr></table></figure></p>
<p>so based on this output it looks like object #11 has some javascript, so I type:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object 11</span><br></pre></td></tr></table></figure></p>
<p>and get:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">var asdf = &quot;NuemnaufOmt8wek4obWeashiMeivanJeatt6&quot;;</span><br><span class="line">var ddas =  &quot;bodcuicMong2&quot;;</span><br><span class="line">var dda22d = &quot;bosOjparj1&quot;</span><br><span class="line">var obGeujRiary = &quot;akPatMyib5EbJetEteip9idWoncainil7&quot;</span><br><span class="line"></span><br><span class="line">function Iadghod3(s) &#123;</span><br><span class="line">  var v = 0;</span><br><span class="line">  for (var i=0; i&lt;4; i++) v |= s.charCodeAt(i) &lt;&lt; i*8;</span><br><span class="line">  return isNaN(v) ? 0 : v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function Vonsheac6(v) &#123;</span><br><span class="line">  var s = String.fromCharCode(v &amp; 0xFF, v&gt;&gt;8 &amp; 0xFF, v&gt;&gt;16 &amp; 0xFF, v&gt;&gt;24 &amp; 0xFF)</span><br><span class="line">;</span><br><span class="line">  return s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function RevUfPhas2(DepKacyuv7, ClashJit0) &#123;</span><br><span class="line">  var v = new Array(2), k = new Array(4), s = &quot;&quot;, i;</span><br><span class="line">  DepKacyuv7 = escape(DepKacyuv7);</span><br><span class="line">  for (var i=0; i&lt;4; i++) k[i] = Iadghod3(ClashJit0.slice(i*4,(i+1)*4));</span><br><span class="line"></span><br><span class="line">  for (i=0; i&lt;DepKacyuv7.length; i+=8) &#123;</span><br><span class="line">    v[0] = Iadghod3(DepKacyuv7.slice(i,i+4));</span><br><span class="line">    v[1] = Iadghod3(DepKacyuv7.slice(i+4,i+8));</span><br><span class="line">    DikVivec2(v, k);</span><br><span class="line">    s += Vonsheac6(v[0]) + Vonsheac6(v[1]);</span><br><span class="line">  &#125;</span><br><span class="line">  return s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function jiUteFraj8(tydAcFod3, ClashJit0) &#123;</span><br><span class="line">  var v = new Array(2), k = new Array(4), s = &quot;&quot;, i;</span><br><span class="line"></span><br><span class="line">  for (var i=0; i&lt;4; i++) k[i] = Iadghod3(ClashJit0.slice(i*4,(i+1)*4));</span><br><span class="line"></span><br><span class="line">  tydAcFod3 = tydAcFod3;</span><br><span class="line">  for (i=0; i&lt;tydAcFod3.length; i+=8) &#123;</span><br><span class="line">    v[0] = Iadghod3(tydAcFod3.slice(i,i+4));</span><br><span class="line">    v[1] = Iadghod3(tydAcFod3.slice(i+4,i+8));</span><br><span class="line">    AdCejMod9(v, k);</span><br><span class="line">    s += Vonsheac6(v[0]) + Vonsheac6(v[1]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  s = s.replace(/ +$/, &apos;&apos;);</span><br><span class="line"></span><br><span class="line">  return unescape(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function DikVivec2(v, k) &#123;</span><br><span class="line"></span><br><span class="line">  var y = v[0], z = v[1];</span><br><span class="line">  var delta = 0x9E3779B9, limit = delta*32, sum = 0;</span><br><span class="line"></span><br><span class="line">  while (sum != limit) &#123;</span><br><span class="line">    y += (z&lt;&lt;4 ^ z&gt;&gt;&gt;5)+z ^ sum+k[sum &amp; 3];</span><br><span class="line">    sum += delta;</span><br><span class="line">    z += (y&lt;&lt;4 ^ y&gt;&gt;&gt;5)+y ^ sum+k[sum&gt;&gt;&gt;11 &amp; 3];</span><br><span class="line">  &#125;</span><br><span class="line">  v[0] = y; v[1] = z;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function AdCejMod9(v, k) &#123;</span><br><span class="line">  var y = v[0], z = v[1];</span><br><span class="line">  var delta = 0x9E3779B9, sum = delta*32;</span><br><span class="line"></span><br><span class="line">  while (sum != 0) &#123;</span><br><span class="line">    z -= (y&lt;&lt;4 ^ y&gt;&gt;&gt;5)+y ^ sum+k[sum&gt;&gt;&gt;11 &amp; 3];</span><br><span class="line">    sum -= delta;</span><br><span class="line">    y -= (z&lt;&lt;4 ^ z&gt;&gt;&gt;5)+z ^ sum+k[sum &amp; 3];</span><br><span class="line">  &#125;</span><br><span class="line">  v[0] = y; v[1] = z;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var atkopNersiv4 = RevUfPhas2(asdf, ddas);</span><br><span class="line">var fakCapFod9 = jiUteFraj8(ddas, obGeujRiary)</span><br><span class="line"></span><br><span class="line">var arnUftad4 = 0x41;</span><br><span class="line">ItOvyof7 = &quot;)5512&#123;nn666o8.454#$o\&quot;.,n6 5\&quot;)~7|%\x106u6x\x16&amp;\x19\&quot;\x10&quot;;</span><br><span class="line">var plain = &quot;&quot;;</span><br><span class="line">for (i = 0; i &lt; ItOvyof7.length; i+=1)&#123;</span><br><span class="line">    plain += String.fromCharCode(ItOvyof7.charCodeAt(i) ^ arnUftad4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>so I fired up <a href="https://nodejs.org/" target="_blank" rel="noopener">NodeJS</a> and blindly run the javascript (tee hee hee). Of course nothing actually happens, but we can examine some varaibles…and the last variable output to the screen <code>plain</code> is a url: <code>https://www.youtube.com/watch?v=dQw4w9WgXcQ</code> which is a nice RickRoll. But lets look at what are the values of the other variables, in a nodeJS REPL we simply type: <code>GLOBAL</code> and we get (relevant only):<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  asdf: &apos;NuemnaufOmt8wek4obWeashiMeivanJeatt6&apos;,</span><br><span class="line">  ddas: &apos;bodcuicMong2&apos;,</span><br><span class="line">  dda22d: &apos;bosOjparj1&apos;,</span><br><span class="line">  obGeujRiary: &apos;akPatMyib5EbJetEteip9idWoncainil7&apos;,</span><br><span class="line">  Iadghod3: [Function: Iadghod3],</span><br><span class="line">  Vonsheac6: [Function: Vonsheac6],</span><br><span class="line">  RevUfPhas2: [Function: RevUfPhas2],</span><br><span class="line">  jiUteFraj8: [Function: jiUteFraj8],</span><br><span class="line">  DikVivec2: [Function: DikVivec2],</span><br><span class="line">  AdCejMod9: [Function: AdCejMod9],</span><br><span class="line">  atkopNersiv4: &apos;\u000bF©&gt;\u0013ä)bï#Í×¾?ÝR¯&quot;¸¨Ã\u0018=\u000fÞ\u0006Ô*|o-DX5¨&apos;,</span><br><span class="line">  fakCapFod9: &apos;Z\nùW\u0006\u001c·såå­\u0017IC2&apos;,</span><br><span class="line">  arnUftad4: 65,</span><br><span class="line">  ItOvyof7: &apos;)5512&#123;nn666o8.454#$o&quot;.,n6 5&quot;)~7|%\u00106u6x\u0016&amp;\u0019&quot;\u0010&apos;,</span><br><span class="line">  plain: &apos;https://www.youtube.com/watch?v=dQw4w9WgXcQ&apos;,</span><br><span class="line">  i: 43 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>hmmm…well if we look at the code the variables <code>atkopNersiv4</code> and <code>fakCapFod9</code> are not used in that final plain text RickRoll, neither is <code>dda22d</code>, so lets play with those for a bit….ok that’s enough of that…this didn’t go anywhere.</p>
<p>At this point I started to look at the parsing errors that the various tools had and trying to figure out why they weren’t parsing well. Instead of digging too deep here, I decided to see what happens if I round trip the pdf. I open in the Acrobat Reader DC, and save it out as a new file…then I run those existing tools and notice an interesting object:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt; /Type /Action</span><br><span class="line">/S /JavaScript</span><br><span class="line">/JS ■  i f ( e v e n t . v a l u e = = &quot; P A N &#123; g 0 o b y g o 0 b y d 0 0 w h 3 r 3 r u ? &#125; &quot; ) &#123; a p p . a l e r t ( &quot; y e s &quot; ) ; &#125; e l s e &#123; a p p . a l e r t ( &quot; n o &quot; ) ; &#125;</span><br><span class="line"> &gt;&gt;</span><br></pre></td></tr></table></figure></p>
<p>well look at that, a PAN{*} value:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PAN&#123;g0obygo0byd00wh3r3ru?&#125;</span><br></pre></td></tr></table></figure></p>
<p>enter it in and</p>
<p>BOOM</p>
<p>we get document #4</p>

	
	</div>
  <a type="button" href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-03/#more" class="btn btn-default more">Read More</a>
</div>

           
		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
        

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/2/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/maldoc/">maldoc<span>5</span></a></li>
		
			<li><a href="/tags/archive/">archive<span>1</span></a></li>
		
			<li><a href="/tags/Labyrenth/">Labyrenth<span>6</span></a></li>
		
			<li><a href="/tags/security/">security<span>5</span></a></li>
		
			<li><a href="/tags/ScreenSaver/">ScreenSaver<span>1</span></a></li>
		
			<li><a href="/tags/obligitory/">obligitory<span>1</span></a></li>
		
			<li><a href="/tags/CTF/">CTF<span>5</span></a></li>
		
			<li><a href="/tags/halfthoughts/">halfthoughts<span>1</span></a></li>
		
			<li><a href="/tags/VB/">VB<span>1</span></a></li>
		
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2018/01/22/New-HTML-Experiments/" ><i class="fa fa-file-o"></i>New HTML Experiments</a>
      </li>
    
      <li>
        <a href="/2016/08/21/My-First-ScreenSaver-an-obsession-in-VB6/" ><i class="fa fa-file-o"></i>My First ScreenSaver - an o...</a>
      </li>
    
      <li>
        <a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-05/" ><i class="fa fa-file-o"></i>2016 Palo Alto Labyrenth CT...</a>
      </li>
    
      <li>
        <a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-04/" ><i class="fa fa-file-o"></i>2016 Palo Alto Labyrenth CT...</a>
      </li>
    
      <li>
        <a href="/2016/08/15/2016-Palo-Alto-Labyrenth-CTF-Doc-03/" ><i class="fa fa-file-o"></i>2016 Palo Alto Labyrenth CT...</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class=""></i><a href="https://twitter.com/DavidBHeise" title="" target="_blank"]);">Twitter</a></li>
	
		<li><i class=""></i><a href="https://github.com/DBHeise" title="" target="_blank"]);">GitHub</a></li>
	
		<li><i class=""></i><a href="http://stackexchange.com/users/7529/david-b-heise" title="" target="_blank"]);">Stack Exchange</a></li>
	
		<li><i class=""></i><a href="https://bitbucket.org/CrazyDave/" title="" target="_blank"]);">BitBucket</a></li>
	
		<li><i class=""></i><a href="http://pastebin.com/u/CrazyDave137" title="" target="_blank"]);">Pastebin</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->


	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2018 Crazy Dave
     
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 




   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
